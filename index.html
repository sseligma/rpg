<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>RPG</title>
        <script type="text/javascript" src="js/pathfinding-browser.min.js"></script>
        <script type="text/javascript" src="js/phaser.min.js"></script>
        <script type="text/javascript" src="js/Map.js"></script>
        <script type="text/javascript" src="js/Actor.js"></script>
        <script type="text/javascript" src="js/Rpg.js"></script>
        
    </head>
    <body>

    <script type="text/javascript">    
    var game;
    var map;
    var currentlayer;
    var player;
    
    var floor_layer;
    var wall_layer;
    var enemies;
    
    var upKey;
    var downKey;
    var leftKey;
    var rightKey;
    
    var directions = {
      'N':{
    	  'x':0,
    	  'y':-1,
    	  'label':'North'
      },      
      'NE':{
          'x':1,
          'y':-1,
          'label':'North East'
      },      
      'E':{
        'x':1,
        'y':0,
        'label':'East'
      },
      'SE':{
          'x':1,
          'y':1,
          'label':'South East'
      },      
      'S':{
        'x':0,
        'y':1,
        'label':'South'
      },
      'SW':{
          'x':-1,
          'y':1,
          'label':'South'
      },
      'W':{
        'x':-1,
        'y':0,
        'label':'West'
      },
      'NW':{
          'x':-1,
          'y':-1,
          'label':'North West'
      }
    };

    window.onload = function() {

        //  Note that this html file is set to pull down Phaser 2.5.0 from the JS Delivr CDN.
        //  Although it will work fine with this tutorial, it's almost certainly not the most current version.
        //  Be sure to replace it with an updated version before you start experimenting with adding your own code.

        game = new Phaser.Game(320, 320, Phaser.AUTO, '', { preload: preload, create: create, update: update });
        game.actors = [];
       
        function preload () {

        	  //game.load.tilemap('tilemap', 'test_map.json', null, Phaser.Tilemap.TILED_JSON);
        	  game.load.image('tiles', 'tilesets/test_tiles_16.png');
        	  //game.load.image('tiles', 'tilesets/test_tiles_32.png');
              
            game.load.spritesheet('sprite_sheet', 'tilesets/test_tiles_16.png', 16, 16, 5);
        	  game.load.image('player_sprite', 'assets/player_16.png');
        	 
            //game.load.image('player_sprite', 'assets/player_32.png');           
        	  
        	  game.load.image('enemy_sprite', 'assets/enemy.png');
            game.load.image('highlight_sprite', 'assets/highlight_16.png');           


        }
        
        function create () {

        	 game.stage.backgroundColor = '#ff0000';

        	  map = game.add.tilemap();

        	  //  The first parameter is the tileset name, as specified in the Tiled map editor (and in the tilemap json file)
        	  //  The second parameter maps this name to the Phaser.Cache key 'tiles'
        	  map.addTilesetImage('tiles','tiles',16,16);
        	  map.randomDungeon();          
        	  
        	  pos = map.getRandomOpenTile();
        	  console.log('placing actor at ');
        	  console.log(pos);
            game.addActor({
              name: 'Player 1',
              controller: 'player',
              map:map,
              x: pos.x,
              y: pos.y,
              sprite: "player_sprite"
            });

            for (var i = 0; i < game.rnd.integerInRange(1, 10); i++) {
            	pos = map.getRandomOpenTile();
              game.addActor({
                name: 'Enemy ' + i,
                map: map,
                x: pos.x,
                y: pos.y,
                sprite: "enemy_sprite"
              });
            }

            playerIndex = 0;

           // Cursor Keys
           upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
           upKey.onDown.add(function(){game.actors[playerIndex].move('N')}, this);
           
           downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
           downKey.onDown.add(function(){game.actors[playerIndex].move('S')}, this);

           
           leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
           leftKey.onDown.add(function(){game.actors[playerIndex].move('W')}, this);

           rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
           rightKey.onDown.add(function(){game.actors[playerIndex].move('E')}, this);
           
           //Numpad Keys
           num8Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_8);
           num8Key.onDown.add(function(){game.actors[playerIndex].move('N')}, this);
           
           num9Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_9);
           num9Key.onDown.add(function(){game.actors[playerIndex].move('NE')}, this);

           num6Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_6);
           num6Key.onDown.add(function(){game.actors[playerIndex].move('E')}, this);

           num3Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_3);
           num3Key.onDown.add(function(){game.actors[playerIndex].move('SE')}, this);

           num2Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_2);
           num2Key.onDown.add(function(){game.actors[playerIndex].move('S')}, this);

           num1Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_1);
           num1Key.onDown.add(function(){game.actors[playerIndex].move('SW')}, this);

           num4Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_4);
           num4Key.onDown.add(function(){game.actors[playerIndex].move('W')}, this);

           num7Key = game.input.keyboard.addKey(Phaser.Keyboard.NUMPAD_7);
           num7Key.onDown.add(function(){game.actors[playerIndex].move('NW')}, this);
           
           // mouse clicks
           game.input.onDown.add(function(pointer, event) { 
        	   // get tile position
        	   var pos = new Position(Math.floor(event.x / map.tileWidth),Math.floor(event.y / map.tileHeight));
        	   console.log(pos);
           });
    }
        
        function findObjectsByType (type, map, layer) {
          var result = new Array();
          for(var i = 0; i < map.objects[layer].length; i++) {
        	  obj = map.objects[layer][i];
        	  if (obj.type == type) {
              obj.y -= map.tileHeight;
        		  result.push(obj);
        	  }
          };
          return result;
        }
        
    };

    
    function update() {

        //  For example this checks if the up or down keys are pressed and moves the camera accordingly.
        /*
        upKey.onUpCallback = function(){
        	console.log('up');
        	player.y+= map.tileHeight;
        }
        */
        /*
        else if (cursors.down.isDown)
        {
            player.y-= map.tileHeight;
        }

        if (cursors.left.isDown)
        {
            player.x-= map.tileWidth;

        }
        else if (cursors.right.isDown)
        {
            player.x+= map.tileWidth;
        }
        */

    }

    function moveActor(actor,d) {
      actor.move(d);	
    }
    
    function movePlayer(d) {
      var currentPosition = {
    		x:player.position.x / map.tileWidth,
    		y:player.position.y / map.tileHeight
      }

      var newPosition = {
    	  x:currentPosition.x + directions[d].x,
        y:currentPosition.y + directions[d].y, 
      }
      
      if (map.hasTile(newPosition.x,newPosition.y,'Walls')) {
    	  console.log('Blocked');
      }
      else {
    	  player.position.x+=directions[d].x * map.tileWidth;
        player.position.y+=directions[d].y * map.tileHeight;
        console.log(directions[d].label);
      }      
    }
    </script>

    </body>
</html>